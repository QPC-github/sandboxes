"use strict";
var __create = Object.create;
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __getProtoOf = Object.getPrototypeOf;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
  isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
  mod
));

// src/manager.tsx
var import_react6 = __toESM(require("react"));
var import_addons = require("@storybook/addons");

// src/components/ToolbarManager.tsx
var import_react5 = __toESM(require("react"));
var import_api3 = require("@storybook/api");
var import_components4 = require("@storybook/components");

// src/components/ToolbarMenuList.tsx
var import_react4 = __toESM(require("react"));
var import_api2 = require("@storybook/api");
var import_components3 = require("@storybook/components");

// src/components/ToolbarMenuButton.tsx
var import_react = __toESM(require("react"));
var import_components = require("@storybook/components");
var ToolbarMenuButton = ({
  active,
  title,
  icon,
  description,
  onClick
}) => {
  return /* @__PURE__ */ import_react.default.createElement(import_components.IconButton, {
    active,
    title: description,
    onClick
  }, icon && /* @__PURE__ */ import_react.default.createElement(import_components.Icons, {
    icon
  }), title ? `\xA0${title}` : null);
};

// src/hoc/withKeyboardCycle.tsx
var import_react2 = __toESM(require("react"));
var import_api = require("@storybook/api");

// src/utils/create-cycle-value-array.ts
var disallowedCycleableItemTypes = ["reset"];
var createCycleValueArray = (items) => {
  const valueArray = items.filter((item) => !disallowedCycleableItemTypes.includes(item.type)).map((item) => item.value);
  return valueArray;
};

// src/constants.ts
var ADDON_ID = "addon-toolbars";

// src/utils/register-shortcuts.ts
var registerShortcuts = async (api, id, shortcuts) => {
  if (shortcuts && shortcuts.next) {
    await api.setAddonShortcut(ADDON_ID, {
      label: shortcuts.next.label,
      defaultShortcut: shortcuts.next.keys,
      actionName: `${id}:next`,
      action: shortcuts.next.action
    });
  }
  if (shortcuts && shortcuts.previous) {
    await api.setAddonShortcut(ADDON_ID, {
      label: shortcuts.previous.label,
      defaultShortcut: shortcuts.previous.keys,
      actionName: `${id}:previous`,
      action: shortcuts.previous.action
    });
  }
  if (shortcuts && shortcuts.reset) {
    await api.setAddonShortcut(ADDON_ID, {
      label: shortcuts.reset.label,
      defaultShortcut: shortcuts.reset.keys,
      actionName: `${id}:reset`,
      action: shortcuts.reset.action
    });
  }
};

// src/hoc/withKeyboardCycle.tsx
var withKeyboardCycle = (Component) => {
  const WithKeyboardCycle = (props) => {
    const {
      id,
      toolbar: { items, shortcuts }
    } = props;
    const api = (0, import_api.useStorybookApi)();
    const [globals, updateGlobals] = (0, import_api.useGlobals)();
    const cycleValues = (0, import_react2.useRef)([]);
    const currentValue = globals[id];
    const reset = (0, import_react2.useCallback)(() => {
      updateGlobals({ [id]: "" });
    }, [updateGlobals]);
    const setNext = (0, import_react2.useCallback)(() => {
      const values = cycleValues.current;
      const currentIndex = values.indexOf(currentValue);
      const currentIsLast = currentIndex === values.length - 1;
      const newCurrentIndex = currentIsLast ? 0 : currentIndex + 1;
      const newCurrent = cycleValues.current[newCurrentIndex];
      updateGlobals({ [id]: newCurrent });
    }, [cycleValues, currentValue, updateGlobals]);
    const setPrevious = (0, import_react2.useCallback)(() => {
      const values = cycleValues.current;
      const indexOf = values.indexOf(currentValue);
      const currentIndex = indexOf > -1 ? indexOf : 0;
      const currentIsFirst = currentIndex === 0;
      const newCurrentIndex = currentIsFirst ? values.length - 1 : currentIndex - 1;
      const newCurrent = cycleValues.current[newCurrentIndex];
      updateGlobals({ [id]: newCurrent });
    }, [cycleValues, currentValue, updateGlobals]);
    (0, import_react2.useEffect)(() => {
      if (shortcuts) {
        registerShortcuts(api, id, {
          next: { ...shortcuts.next, action: setNext },
          previous: { ...shortcuts.previous, action: setPrevious },
          reset: { ...shortcuts.reset, action: reset }
        });
      }
    }, [api, id, shortcuts, setNext, setPrevious, reset]);
    (0, import_react2.useEffect)(() => {
      cycleValues.current = createCycleValueArray(items);
    }, []);
    return /* @__PURE__ */ import_react2.default.createElement(Component, {
      cycleValues: cycleValues.current,
      ...props
    });
  };
  return WithKeyboardCycle;
};

// src/utils/get-selected.ts
var getSelectedItem = ({ currentValue, items }) => {
  const selectedItem = currentValue != null && items.find((item) => item.value === currentValue);
  return selectedItem;
};
var getSelectedIcon = ({ currentValue, items }) => {
  const selectedItem = getSelectedItem({ currentValue, items });
  if (selectedItem) {
    return selectedItem.icon;
  }
  return void 0;
};
var getSelectedTitle = ({ currentValue, items }) => {
  const selectedItem = getSelectedItem({ currentValue, items });
  if (selectedItem) {
    return selectedItem.title;
  }
  return void 0;
};

// src/components/ToolbarMenuListItem.tsx
var import_react3 = __toESM(require("react"));
var import_components2 = require("@storybook/components");
var ToolbarMenuListItem = ({
  left,
  right,
  title,
  value,
  icon,
  hideIcon,
  onClick,
  currentValue
}) => {
  const Icon = icon && /* @__PURE__ */ import_react3.default.createElement(import_components2.Icons, {
    style: { opacity: 1 },
    icon
  });
  const hasContent = left || right || title;
  const Item = {
    id: value || currentValue,
    active: currentValue === value,
    onClick
  };
  if (left) {
    Item.left = left;
  }
  if (right) {
    Item.right = right;
  }
  if (title) {
    Item.title = title;
  }
  if (icon && !hideIcon) {
    if (hasContent && !right) {
      Item.right = Icon;
    } else if (hasContent && !left) {
      Item.left = Icon;
    } else if (!hasContent) {
      Item.right = Icon;
    }
  }
  return Item;
};

// src/components/ToolbarMenuList.tsx
var ToolbarMenuList = withKeyboardCycle(
  ({
    id,
    name,
    description,
    toolbar: { icon: _icon, items, title: _title, showName, preventDynamicIcon, dynamicTitle }
  }) => {
    const [globals, updateGlobals] = (0, import_api2.useGlobals)();
    const currentValue = globals[id];
    const hasGlobalValue = !!currentValue;
    let icon = _icon;
    let title = _title;
    if (!preventDynamicIcon) {
      icon = getSelectedIcon({ currentValue, items }) || icon;
    }
    if (showName && !title) {
      title = name;
      console.warn(
        "`showName` is deprecated as `name` will stop having dual purposes in the future. Please specify a `title` in `globalTypes` instead."
      );
    } else if (!showName && !icon && !title) {
      title = name;
      console.warn(
        `Using the \`name\` "${name}" as toolbar title for backward compatibility. \`name\` will stop having dual purposes in the future. Please specify either a \`title\` or an \`icon\` in \`globalTypes\` instead.`
      );
    }
    if (dynamicTitle) {
      title = getSelectedTitle({ currentValue, items }) || title;
    }
    const handleItemClick = (0, import_react4.useCallback)(
      (value) => {
        updateGlobals({ [id]: value });
      },
      [currentValue, updateGlobals]
    );
    return /* @__PURE__ */ import_react4.default.createElement(import_components3.WithTooltip, {
      placement: "top",
      trigger: "click",
      tooltip: ({ onHide }) => {
        const links = items.filter(({ type }) => {
          let shouldReturn = true;
          if (type === "reset" && !currentValue) {
            shouldReturn = false;
          }
          return shouldReturn;
        }).map((item) => {
          const listItem = ToolbarMenuListItem({
            ...item,
            currentValue,
            onClick: () => {
              handleItemClick(item.value);
              onHide();
            }
          });
          return listItem;
        });
        return /* @__PURE__ */ import_react4.default.createElement(import_components3.TooltipLinkList, {
          links
        });
      },
      closeOnClick: true
    }, /* @__PURE__ */ import_react4.default.createElement(ToolbarMenuButton, {
      active: hasGlobalValue,
      description: description || "",
      icon,
      title: title || ""
    }));
  }
);

// src/utils/normalize-toolbar-arg-type.ts
var defaultItemValues = {
  type: "item",
  value: ""
};
var normalizeArgType = (key, argType) => ({
  ...argType,
  name: argType.name || key,
  description: argType.description || key,
  toolbar: {
    ...argType.toolbar,
    items: argType.toolbar.items.map((_item) => {
      const item = typeof _item === "string" ? { value: _item, title: _item } : _item;
      if (item.type === "reset" && argType.toolbar.icon) {
        item.icon = argType.toolbar.icon;
        item.hideIcon = true;
      }
      return { ...defaultItemValues, ...item };
    })
  }
});

// src/components/ToolbarManager.tsx
var ToolbarManager = () => {
  const globalTypes = (0, import_api3.useGlobalTypes)();
  const globalIds = Object.keys(globalTypes).filter((id) => !!globalTypes[id].toolbar);
  if (!globalIds.length) {
    return null;
  }
  return /* @__PURE__ */ import_react5.default.createElement(import_react5.default.Fragment, null, /* @__PURE__ */ import_react5.default.createElement(import_components4.Separator, null), globalIds.map((id) => {
    const normalizedArgType = normalizeArgType(id, globalTypes[id]);
    return /* @__PURE__ */ import_react5.default.createElement(ToolbarMenuList, {
      key: id,
      id,
      ...normalizedArgType
    });
  }));
};

// src/manager.tsx
import_addons.addons.register(
  ADDON_ID,
  () => import_addons.addons.add(ADDON_ID, {
    title: ADDON_ID,
    type: import_addons.types.TOOL,
    match: () => true,
    render: () => /* @__PURE__ */ import_react6.default.createElement(ToolbarManager, null)
  })
);
