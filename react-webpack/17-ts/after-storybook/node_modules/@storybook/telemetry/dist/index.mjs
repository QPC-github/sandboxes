var x=(e=>typeof require!="undefined"?require:typeof Proxy!="undefined"?new Proxy(e,{get:(o,t)=>(typeof require!="undefined"?require:o)[t]}):e)(function(e){if(typeof require!="undefined")return require.apply(this,arguments);throw new Error('Dynamic require of "'+e+'" is not supported')});var i={};import{logger as C}from"@storybook/client-logger";import q from"read-pkg-up";import{detect as G,getNpmVersion as K}from"detect-package-manager";import{loadMainConfig as Q,getStorybookInfo as X,getStorybookConfiguration as Z,getProjectRoot as ee}from"@storybook/core-common";import U from"path";var k=async e=>{let o=Object.keys(e);return Promise.all(o.map(b))},b=async e=>{try{let o=x(U.join(e,"package.json"));return{name:e,version:o.version}}catch{return{name:e,version:null}}};import h from"fs-extra";import P from"path";import{getProjectRoot as H}from"@storybook/core-common";var v={Nx:"nx.json",Turborepo:"turbo.json",Lerna:"lerna.json",Rush:"rush.json",Lage:"lage.config.json"},O=()=>{let e=H();if(!e)return;let t=Object.keys(v).find(s=>{let y=P.join(e,v[s]);return h.existsSync(y)});if(t)return t;if(!h.existsSync(P.join(e,"package.json")))return;if(h.readJsonSync(P.join(e,"package.json"))?.workspaces)return"Workspaces"};import{sep as D}from"path";function T(e){return e.replace(/[-[/{}()*+?.\\^$|]/g,"\\$&")}function w(e,o=D){if(!e)return e;let t=process.cwd().split(o);for(;t.length>1;){let n=t.join(o),s=new RegExp(T(n),"g");e=e.replace(s,"$SNIP");let y=t.join(o+o),c=new RegExp(T(y),"g");e=e.replace(c,"$SNIP"),t.pop()}return e}function E(e,o=D){e=JSON.parse(JSON.stringify(e,Object.getOwnPropertyNames(e)));let t=w(JSON.stringify(e),o);return JSON.parse(t)}var R={next:"Next","react-scripts":"CRA",gatsby:"Gatsby","@nuxtjs/storybook":"nuxt","@nrwl/storybook":"nx","@vue/cli-service":"vue-cli","@sveltejs/kit":"svelte-kit"},oe=e=>{let o=["angular","ember","html","preact","react","server","svelte","vue","vue3","webComponents"].map(t=>`${t}Options`);for(let t of o)if(t in e)return e[t]},N=e=>w(e).replace(/\/dist\/.*/,"").replace(/\.[mc]?[tj]?s[x]?$/,"").replace(/\/register$/,"").replace(/\/manager$/,"").replace(/\/preset$/,""),te=async({packageJson:e,mainConfig:o})=>{let t={generatedAt:new Date().getTime(),builder:{name:"webpack5"},hasCustomBabel:!1,hasCustomWebpack:!1,hasStaticDirs:!1,hasStorybookEslint:!1,refCount:0},n={...e?.dependencies,...e?.devDependencies,...e?.peerDependencies},s=Object.keys(n).find(r=>!!R[r]);if(s){let{version:r}=await b(s);t.metaFramework={name:R[s],packageName:s,version:r}}let y=O();y&&(t.monorepo=y);try{let r=await G({cwd:ee()}),a=await K(r);t.packageManager={type:r,version:a}}catch{}if(t.hasCustomBabel=!!o.babel,t.hasCustomWebpack=!!o.webpackFinal,t.hasStaticDirs=!!o.staticDirs,o.typescript&&(t.typescriptOptions=o.typescript),o.core?.builder){let{builder:r}=o.core;t.builder={name:typeof r=="string"?r:r.name,options:typeof r=="string"?void 0:r?.options??void 0}}o.refs&&(t.refCount=Object.keys(o.refs).length),o.features&&(t.features=o.features);let c={};o.addons&&o.addons.forEach(r=>{let a,S;typeof r=="string"?a=N(r):(S=r.options,a=N(r.name)),c[a]={options:S,version:void 0}}),(await k(c)).forEach(({name:r,version:a})=>{c[r].version=a});let m=Object.keys(c),p=Object.keys(n).filter(r=>r.includes("storybook")&&!m.includes(r)).reduce((r,a)=>({...r,[a]:{version:void 0}}),{});(await k(p)).forEach(({name:r,version:a})=>{p[r].version=a});let W=n.typescript?"typescript":"javascript",Y=!!n["eslint-plugin-storybook"],u=X(e),_=p[u.frameworkPackage]?.version||u.version;return{...t,storybookVersion:_,language:W,storybookPackages:p,framework:{name:u.framework,options:oe(o)},addons:c,hasStorybookEslint:Y}},f,M=async e=>{if(f)return f;let{packageJson:o={}}=q.sync({cwd:process.cwd(),normalize:!1})||{},t=(e||Z(o?.scripts?.storybook||"","-c","--config-dir"))??".storybook",n=Q({configDir:t});return f=await te({mainConfig:n,packageJson:o}),f};import ie from"isomorphic-unfetch";import ce from"fetch-retry";import{nanoid as J}from"nanoid";import ne from"path";import{execSync as se}from"child_process";import{getProjectRoot as ae}from"@storybook/core-common";import{createHash as re}from"crypto";var I=e=>{let o=re("sha256");return o.update("storybook-telemetry-salt"),o.update(e),o.digest("hex")};var g,A=()=>{if(g)return g;let e;try{let o=ae(),t=ne.relative(o,process.cwd()),n=se("git config --local --get remote.origin.url",{timeout:1e3,stdio:"pipe"});e=`${String(n).trim()}${t}`,g=I(e)}catch{}return g};var pe="https://storybook.js.org/event-log",ye=ce(ie),d=[],me=J();async function $(e,o={retryDelay:1e3,immediate:!1}){let{payload:t,metadata:n,...s}=e,y={anonymousId:A(),inCI:i.CI==="true"},c=J(),j={...s,eventId:c,sessionId:me,metadata:n,payload:t,context:y},m;try{m=ye(pe,{method:"POST",body:JSON.stringify(j),headers:{"Content-Type":"application/json"},retries:3,retryOn:[503,504],retryDelay:p=>2**p*(typeof o?.retryDelay=="number"&&!Number.isNaN(o?.retryDelay)?o.retryDelay:1e3)}),d.push(m),o.immediate?await Promise.all(d):await m}catch{}finally{d=d.filter(p=>p!==m)}}import V from"chalk";import{cache as B}from"@storybook/core-common";var F="telemetry-notification-date",l=console,L=async()=>{await B.get(F,null)||(B.set(F,Date.now()),l.log(),l.log(`${V.magenta.bold("attention")} => Storybook now collects completely anonymous telemetry regarding usage.`),l.log("This information is used to shape Storybook's roadmap and prioritize features."),l.log("You can learn more, including how to opt-out if you'd not like to participate in this anonymous program, by visiting the following URL:"),l.log(V.cyan("https://storybook.js.org/telemetry")),l.log())};var Qe=async(e,o={},t={})=>{await L();let n={eventType:e,payload:o};try{n.metadata=await M(t?.configDir)}catch(s){n.payload.error||(n.payload.error=s)}finally{let{error:s}=n.payload;s&&(n.payload.error=E(s)),(!n.payload.error||t?.enableCrashReports)&&(i?.STORYBOOK_TELEMETRY_DEBUG?(C.info(`
[telemetry]`),C.info(JSON.stringify(n,null,2))):await $(n,t))}};export{te as computeStorybookMetadata,M as getStorybookMetadata,R as metaFrameworks,N as sanitizeAddonName,Qe as telemetry};
