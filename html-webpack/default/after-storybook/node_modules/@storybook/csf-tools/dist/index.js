var Y=Object.create;var y=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var tt=Object.getOwnPropertyNames;var et=Object.getPrototypeOf,rt=Object.prototype.hasOwnProperty;var st=(s,t)=>{for(var i in t)y(s,i,{get:t[i],enumerable:!0})},R=(s,t,i,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let e of tt(t))!rt.call(s,e)&&e!==i&&y(s,e,{get:()=>t[e],enumerable:!(r=Z(t,e))||r.enumerable});return s};var d=(s,t,i)=>(i=s!=null?Y(et(s)):{},R(t||!s||!s.__esModule?y(i,"default",{value:s,enumerable:!0}):i,s)),it=s=>R(y({},"__esModule",{value:!0}),s);var dt={};st(dt,{ConfigFile:()=>S,CsfFile:()=>j,NoMetaError:()=>O,formatConfig:()=>X,formatCsf:()=>z,getStorySortParameter:()=>mt,loadConfig:()=>Q,loadCsf:()=>J,readConfig:()=>ct,readCsf:()=>at,writeConfig:()=>ft,writeCsf:()=>lt});module.exports=it(dt);var I=d(require("fs-extra")),b=require("ts-dedent"),o=d(require("@babel/types")),D=d(require("@babel/generator")),q=d(require("@babel/traverse")),x=require("@storybook/csf");var M=require("@babel/parser"),E=s=>(0,M.parse)(s,{sourceType:"module",plugins:["jsx","typescript",["decorators",{decoratorsBeforeExport:!0}],"classProperties"],tokens:!0});var T=console;function ot(s){if(o.isArrayExpression(s))return s.elements.map(t=>{if(o.isStringLiteral(t))return t.value;throw new Error(`Expected string literal: ${t}`)});if(o.isStringLiteral(s))return new RegExp(s.value);if(o.isRegExpLiteral(s))return new RegExp(s.pattern,s.flags);throw new Error(`Unknown include/exclude: ${s}`)}var _=(s,t)=>{let i=null,r=null;return t.body.find(e=>(o.isVariableDeclaration(e)?r=e.declarations:o.isExportNamedDeclaration(e)&&o.isVariableDeclaration(e.declaration)&&(r=e.declaration.declarations),r&&r.find(n=>o.isVariableDeclarator(n)&&o.isIdentifier(n.id)&&n.id.name===s?(i=n.init,!0):!1))),i},h=(s,t)=>{let{line:i,column:r}=s.loc.start;return`${t||""} (line ${i}, col ${r})`.trim()},L=(s,t,i)=>{let r=s;if(o.isCallExpression(s)){let{callee:e,arguments:n}=s;if(o.isProgram(t)&&o.isMemberExpression(e)&&o.isIdentifier(e.object)&&o.isIdentifier(e.property)&&e.property.name==="bind"&&(n.length===0||n.length===1&&o.isObjectExpression(n[0])&&n[0].properties.length===0)){let a=e.object.name,c=_(a,t);c&&(i._templates[a]=c,r=c)}}return o.isArrowFunctionExpression(r)||o.isFunctionDeclaration(r)?r.params.length>0:!1},nt=s=>{if(o.isArrayExpression(s))return s.elements.map(t=>{if(o.isStringLiteral(t))return t.value;throw new Error(`Expected string literal named export: ${t}`)});throw new Error(`Expected array of string literals: ${s}`)},U=(s,t)=>t.reduce((i,r)=>{let e=s[r];return e&&(i[r]=e),i},{}),O=class extends Error{constructor(t,i){super(b.dedent`
      CSF: missing default export ${h(t,i)}

      More info: https://storybook.js.org/docs/react/writing-stories/introduction#default-export
    `),this.name=this.constructor.name}},j=class{constructor(t,{fileName:i,makeTitle:r}){this._stories={};this._metaAnnotations={};this._storyExports={};this._storyAnnotations={};this._templates={};this._ast=t,this._fileName=i,this.imports=[],this._makeTitle=r}_parseTitle(t){let i=o.isIdentifier(t)?_(t.name,this._ast.program):t;if(o.isStringLiteral(i))return i.value;throw new Error(b.dedent`
      CSF: unexpected dynamic title ${h(i,this._fileName)}

      More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#string-literal-titles
    `)}_parseMeta(t,i){let r={};t.properties.forEach(e=>{if(o.isIdentifier(e.key)){if(this._metaAnnotations[e.key.name]=e.value,e.key.name==="title")r.title=this._parseTitle(e.value);else if(["includeStories","excludeStories"].includes(e.key.name))r[e.key.name]=ot(e.value);else if(e.key.name==="component"){let{code:n}=(0,D.default)(e.value,{});r.component=n}else if(e.key.name==="id")if(o.isStringLiteral(e.value))r.id=e.value.value;else throw new Error(`Unexpected component id: ${e.value}`)}}),this._meta=r}parse(){let t=this;if((0,q.default)(this._ast,{ExportDefaultDeclaration:{enter({node:r,parent:e}){let n,a=o.isIdentifier(r.declaration)&&o.isProgram(e)?_(r.declaration.name,e):r.declaration;o.isObjectExpression(a)?n=a:o.isTSAsExpression(a)&&o.isObjectExpression(a.expression)&&(n=a.expression),!t._meta&&n&&o.isProgram(e)&&t._parseMeta(n,e)}},ExportNamedDeclaration:{enter({node:r,parent:e}){let n;o.isVariableDeclaration(r.declaration)?n=r.declaration.declarations.filter(a=>o.isVariableDeclarator(a)):o.isFunctionDeclaration(r.declaration)&&(n=[r.declaration]),n?n.forEach(a=>{if(o.isIdentifier(a.id)){let{name:c}=a.id;if(c==="__namedExportsOrder"&&o.isVariableDeclarator(a)){t._namedExportsOrder=nt(a.init);return}t._storyExports[c]=a;let m=(0,x.storyNameFromExport)(c);t._storyAnnotations[c]?T.warn(`Unexpected annotations for "${c}" before story declaration`):t._storyAnnotations[c]={};let p;if(o.isVariableDeclarator(a)&&o.isObjectExpression(a.init)){let g=!0;a.init.properties.forEach(u=>{o.isIdentifier(u.key)&&(u.key.name==="render"?g=L(u.value,e,t):u.key.name==="name"&&o.isStringLiteral(u.value)?m=u.value.value:u.key.name==="storyName"&&o.isStringLiteral(u.value)&&T.warn(`Unexpected usage of "storyName" in "${c}". Please use "name" instead.`),t._storyAnnotations[c][u.key.name]=u.value)}),p={__isArgsStory:g}}else{let g=o.isVariableDeclarator(a)?a.init:a;p={__isArgsStory:L(g,e,t)}}t._stories[c]={id:"FIXME",name:m,parameters:p}}}):r.specifiers.length>0&&r.specifiers.forEach(a=>{if(o.isExportSpecifier(a)&&o.isIdentifier(a.exported)){let{name:c}=a.exported;if(c==="default"){let m,p=o.isProgram(e)?_(a.local.name,e):a.local;o.isObjectExpression(p)?m=p:o.isTSAsExpression(p)&&o.isObjectExpression(p.expression)&&(m=p.expression),!t._meta&&m&&o.isProgram(e)&&t._parseMeta(m,e)}else t._storyAnnotations[c]={},t._stories[c]={id:"FIXME",name:c,parameters:{}}}})}},ExpressionStatement:{enter({node:r,parent:e}){let{expression:n}=r;if(o.isProgram(e)&&o.isAssignmentExpression(n)&&o.isMemberExpression(n.left)&&o.isIdentifier(n.left.object)&&o.isIdentifier(n.left.property)){let a=n.left.object.name,c=n.left.property.name,m=n.right;if(t._storyAnnotations[a]&&(c==="story"&&o.isObjectExpression(m)?m.properties.forEach(p=>{o.isIdentifier(p.key)&&(t._storyAnnotations[a][p.key.name]=p.value)}):t._storyAnnotations[a][c]=m),c==="storyName"&&o.isStringLiteral(m)){let p=m.value,g=t._stories[a];if(!g)return;g.name=p}}}},CallExpression:{enter({node:r}){let{callee:e}=r;if(o.isIdentifier(e)&&e.name==="storiesOf")throw new Error(b.dedent`
              CSF: unexpected storiesOf call ${h(r,t._fileName)}

              More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#story-store-v7
            `)}},ImportDeclaration:{enter({node:r}){let{source:e}=r;if(o.isStringLiteral(e))t.imports.push(e.value);else throw new Error("CSF: unexpected import source")}}}),!t._meta)throw new O(t._ast,t._fileName);if(!t._meta.title&&!t._meta.component)throw new Error(b.dedent`
        CSF: missing title/component ${h(t._ast,t._fileName)}

        More info: https://storybook.js.org/docs/react/writing-stories/introduction#default-export
      `);let i=Object.entries(t._stories);if(t._meta.title=this._makeTitle(t._meta.title),t._stories=i.reduce((r,[e,n])=>{if((0,x.isExportStory)(e,t._meta)){let a=(0,x.toId)(t._meta.id||t._meta.title,(0,x.storyNameFromExport)(e)),c={...n.parameters,__id:a};i.length===1&&e==="__page"&&(c.docsOnly=!0),r[e]={...n,id:a,parameters:c}}return r},{}),Object.keys(t._storyExports).forEach(r=>{(0,x.isExportStory)(r,t._meta)||(delete t._storyExports[r],delete t._storyAnnotations[r])}),t._namedExportsOrder){let r=Object.keys(t._storyExports);t._storyExports=U(t._storyExports,t._namedExportsOrder),t._stories=U(t._stories,t._namedExportsOrder);let e=Object.keys(t._storyExports);if(r.length!==e.length)throw new Error(`Missing exports after sort: ${r.filter(n=>!e.includes(n))}`)}return t}get meta(){return this._meta}get stories(){return Object.values(this._stories)}},J=(s,t)=>{let i=E(s);return new j(i,t)},z=s=>{let{code:t}=(0,D.default)(s._ast,{});return t},at=async(s,t)=>{let i=(await I.default.readFile(s,"utf-8")).toString();return J(i,{...t,fileName:s})},lt=async(s,t)=>{if(!(t||s._fileName))throw new Error("Please specify a fileName for writeCsf");await I.default.writeFile(t,await z(s))};var V=d(require("fs-extra")),l=d(require("@babel/types")),w=d(require("@babel/generator")),k=d(require("@babel/traverse"));var G=console,A=s=>l.isIdentifier(s.key)?s.key.name:l.isStringLiteral(s.key)?s.key.value:null,K=(s,t)=>{if(s.length===0)return t;if(l.isObjectExpression(t)){let[i,...r]=s,e=t.properties.find(n=>A(n)===i);if(e)return K(r,e.value)}},P=(s,t)=>{let i=null,r=null;return t.body.find(e=>(l.isVariableDeclaration(e)?r=e.declarations:l.isExportNamedDeclaration(e)&&l.isVariableDeclaration(e.declaration)&&(r=e.declaration.declarations),r&&r.find(n=>l.isVariableDeclarator(n)&&l.isIdentifier(n.id)&&n.id.name===s?(i=n.init,!0):!1))),i},N=(s,t)=>{if(s.length===0)return t;let[i,...r]=s,e=N(r,t);return l.objectExpression([l.objectProperty(l.identifier(i),e)])},F=(s,t,i)=>{let[r,...e]=s,n=i.properties.find(a=>A(a)===r);n?l.isObjectExpression(n.value)&&e.length>0?F(e,t,n.value):n.value=N(e,t):i.properties.push(l.objectProperty(l.identifier(r),N(e,t)))},S=class{constructor(t,i,r){this._exports={};this._ast=t,this._code=i,this.fileName=r}parse(){let t=this;return(0,k.default)(this._ast,{ExportNamedDeclaration:{enter({node:i,parent:r}){l.isVariableDeclaration(i.declaration)?i.declaration.declarations.forEach(e=>{if(l.isVariableDeclarator(e)&&l.isIdentifier(e.id)){let{name:n}=e.id,a=e.init;l.isIdentifier(a)&&(a=P(a.name,r)),t._exports[n]=a}}):G.warn(`Unexpected ${JSON.stringify(i)}`)}},ExpressionStatement:{enter({node:i,parent:r}){if(l.isAssignmentExpression(i.expression)&&i.expression.operator==="="){let{left:e,right:n}=i.expression;if(l.isMemberExpression(e)&&l.isIdentifier(e.object)&&e.object.name==="module"&&l.isIdentifier(e.property)&&e.property.name==="exports"){let a=n;l.isIdentifier(n)&&(a=P(n.name,r)),l.isObjectExpression(a)?(t._exportsObject=a,a.properties.forEach(c=>{let m=A(c);if(m){let p=c.value;l.isIdentifier(p)&&(p=P(p.name,r)),t._exports[m]=p}})):G.warn(`Unexpected ${JSON.stringify(i)}`)}}}}}),t}getFieldNode(t){let[i,...r]=t,e=this._exports[i];if(!!e)return K(r,e)}getFieldValue(t){let i=this.getFieldNode(t);if(i){let{code:r}=(0,w.default)(i,{});return(0,eval)(`(() => (${r}))()`)}}setFieldNode(t,i){let[r,...e]=t,n=this._exports[r];if(this._exportsObject)F(t,i,this._exportsObject),this._exports[t[0]]=i;else if(n&&l.isObjectExpression(n)&&e.length>0)F(e,i,n);else{let a=N(e,i),c=l.exportNamedDeclaration(l.variableDeclaration("const",[l.variableDeclarator(l.identifier(r),a)]));this._exports[r]=a,this._ast.program.body.push(c)}}_inferQuotes(){if(!this._quotes){let t=(this._ast.tokens||[]).slice(0,500).reduce((i,r)=>(r.type.label==="string"&&(i[this._code[r.start]]+=1),i),{"'":0,'"':0});this._quotes=t["'"]>t['"']?"single":"double"}return this._quotes}setFieldValue(t,i){let r=this._inferQuotes(),e;if(r==="single"){let{code:n}=(0,w.default)(l.valueToNode(i),{jsescOption:{quotes:r}}),a=E(`const __x = ${n}`);(0,k.default)(a,{VariableDeclaration:{enter({node:c}){c.declarations.length===1&&l.isVariableDeclarator(c.declarations[0])&&l.isIdentifier(c.declarations[0].id)&&c.declarations[0].id.name==="__x"&&(e=c.declarations[0].init)}}})}else e=l.valueToNode(i);if(!e)throw new Error(`Unexpected value ${JSON.stringify(i)}`);this.setFieldNode(t,e)}},Q=(s,t)=>{let i=E(s);return new S(i,s,t)},X=s=>{let{code:t}=(0,w.default)(s._ast,{});return t},ct=async s=>{let t=(await V.default.readFile(s,"utf-8")).toString();return Q(t,s).parse()},ft=async(s,t)=>{let i=t||s.fileName;if(!i)throw new Error("Please specify a fileName for writeConfig");await V.default.writeFile(i,await X(s))};var f=d(require("@babel/types")),H=d(require("@babel/traverse")),C=d(require("@babel/generator")),W=require("ts-dedent");var pt=console,B=(s,t)=>{let i;return s.properties.forEach(r=>{f.isIdentifier(r.key)&&r.key.name===t&&(i=r.value)}),i},$=s=>{if(f.isArrayExpression(s))return s.elements.map(t=>$(t));if(f.isObjectExpression(s))return s.properties.reduce((t,i)=>(f.isIdentifier(i.key)&&(t[i.key.name]=$(i.value)),t),{});if(f.isLiteral(s))return s.value;throw new Error(`Unknown node type ${s}`)},v=(s,t)=>{let i=W.dedent`
    Unexpected '${s}'. Parameter 'options.storySort' should be defined inline e.g.:

    export const parameters = {
      options: {
        storySort: <array | object | function>
      }
    }
  `;if(t)throw new Error(i);pt.info(i)},mt=s=>{let t,i=E(s);if((0,H.default)(i,{ExportNamedDeclaration:{enter({node:r}){f.isVariableDeclaration(r.declaration)?r.declaration.declarations.forEach(e=>{if(f.isVariableDeclarator(e)&&f.isIdentifier(e.id)){let{name:n}=e.id;if(n==="parameters"){let a=f.isTSAsExpression(e.init)?e.init.expression:e.init;if(f.isObjectExpression(a)){let c=B(a,"options");c&&(f.isObjectExpression(c)?t=B(c,"storySort"):v("options",!0))}else v("parameters",!0)}}}):r.specifiers.forEach(e=>{f.isIdentifier(e.exported)&&e.exported.name==="parameters"&&v("parameters",!1)})}}}),!!t){if(f.isArrowFunctionExpression(t)){let{code:r}=(0,C.default)(t,{});return(0,eval)(r)}if(f.isFunctionExpression(t)){let{code:r}=(0,C.default)(t,{}),e=t.id.name,n=`(a, b) => {
      ${r};
      return ${e}(a, b)
    }`;return(0,eval)(n)}return f.isLiteral(t)||f.isArrayExpression(t)||f.isObjectExpression(t)?$(t):v("storySort",!0)}};0&&(module.exports={ConfigFile,CsfFile,NoMetaError,formatConfig,formatCsf,getStorySortParameter,loadConfig,loadCsf,readConfig,readCsf,writeConfig,writeCsf});
