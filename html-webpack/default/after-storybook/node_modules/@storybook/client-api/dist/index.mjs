import{dedent as z}from"ts-dedent";import V from"global";import{logger as j}from"@storybook/client-logger";import{toId as Y,sanitize as K}from"@storybook/csf";import{combineParameters as R,composeStepRunners as Q,normalizeInputTypes as O}from"@storybook/store";import P from"global";import{dedent as G}from"ts-dedent";import{SynchronousPromise as C}from"synchronous-promise";import{toId as T,isExportStory as $,storyNameFromExport as v}from"@storybook/csf";import{userOrAutoTitle as M,sortStoriesV6 as D}from"@storybook/store";import{logger as L}from"@storybook/client-logger";import N from"util-deprecate";var _=N(()=>{},"You cannot use `.mdx` files without using `storyStoreV7`. Consider upgrading to the new store."),w=class{constructor(){this.projectAnnotations={loaders:[],decorators:[],parameters:{},argsEnhancers:[],argTypesEnhancers:[],args:{},argTypes:{}},this.entries={},this.csfExports={}}importFn(r){return C.resolve().then(()=>{let e=this.csfExports[r];if(!e)throw new Error(`Unknown path: ${r}`);return e})}getStoryIndex(r){let e=Object.keys(this.csfExports),c=this.projectAnnotations.parameters?.options?.storySort,g=Object.entries(this.entries).map(([s,{type:y,importPath:o,...i}])=>{let n=this.csfExports[o],d=r.processCSFFileWithCache(n,o,n.default.title),h;return y==="story"?h=r.storyFromCSFFile({storyId:s,csfFile:d}):h={...i,story:i.name,kind:i.title,componentId:T(i.componentId||i.title),parameters:{fileName:o}},[s,h,d.meta.parameters,this.projectAnnotations.parameters]}),m;try{m=D(g,c,e)}catch(s){throw typeof c=="function"?new Error(G`
          Error sorting stories with sort parameter ${c}:

          > ${s.message}
          
          Are you using a V7-style sort function in V6 compatibility mode?
          
          More info: https://github.com/storybookjs/storybook/blob/next/MIGRATION.md#v7-style-story-sort
        `):s}let t=m.reduce((s,y)=>(s[y.id]=this.entries[y.id],s),{});return{v:4,entries:t}}clearFilenameExports(r){!this.csfExports[r]||(Object.entries(this.entries).forEach(([e,{importPath:c}])=>{c===r&&delete this.entries[e]}),this.csfExports[r]={})}addStoriesFromExports(r,e){if(r.match(/\.mdx$/)&&!r.match(/\.stories\.mdx$/)){_();return}if(this.csfExports[r]===e)return;this.clearFilenameExports(r);let{default:c,__namedExportsOrder:p,...g}=e,{id:m,title:t}=c||{},s=(P.STORIES||[]).map(n=>({...n,importPathMatcher:new RegExp(n.importPathMatcher)}));if(t=M(r,s,t),!t){L.info(`Unexpected default export without title in '${r}': ${JSON.stringify(e.default)}`);return}this.csfExports[r]={...e,default:{...c,title:t}};let y=g;Array.isArray(p)&&(y={},p.forEach(n=>{let d=g[n];d&&(y[n]=d)}));let o=P.DOCS_OPTIONS||{},i=new Set;Object.entries(y).filter(([n])=>$(n,c)).forEach(([n,d])=>{let h=v(n),u=d.parameters?.__id||T(m||t,h),x=typeof d!="function"&&d.name||d.storyName||d.story?.name||h;if(!i.has(t)&&o.docsPage){let A=o.defaultName,S=T(m||t,A);i.add(t),this.entries[S]={type:"docs",standalone:!1,id:S,title:t,name:A,importPath:r,storiesImports:[],componentId:m}}this.entries[u]={type:"story",id:u,name:x,title:t,importPath:r,componentId:m}})}};var f,U={addDecorator:"Instead, use `export const decorators = [];` in your `preview.js`.",addParameters:"Instead, use `export const parameters = {};` in your `preview.js`.",addLoader:"Instead, use `export const loaders = [];` in your `preview.js`.",addArgs:"",addArgTypes:"",addArgsEnhancer:"",addArgTypesEnhancer:"",addStepRunner:"",getGlobalRender:"",setGlobalRender:""},l=a=>{if(V.FEATURES?.storyStoreV7)throw new Error(z`You cannot use \`${a}\` with the new Story Store.

      ${U[a]}`);if(!f)throw new Error(`Singleton client API not yet initialized, cannot call \`${a}\`.`)},W=a=>{l("addDecorator"),f.addDecorator(a)},B=a=>{l("addParameters"),f.addParameters(a)},H=a=>{l("addLoader"),f.addLoader(a)},J=a=>{l("addArgs"),f.addArgs(a)},q=a=>{l("addArgTypes"),f.addArgTypes(a)},X=a=>{l("addArgsEnhancer"),f.addArgsEnhancer(a)},Z=a=>{l("addArgTypesEnhancer"),f.addArgTypesEnhancer(a)},rr=a=>{l("addStepRunner"),f.addStepRunner(a)};var tr=a=>{l("setGlobalRender"),f.facade.projectAnnotations.render=a},er=new Set(["string","number","boolean","symbol"]),b=class{constructor({storyStore:r}={}){this.lastFileName=0;this.addDecorator=r=>{this.facade.projectAnnotations.decorators.push(r)};this.addParameters=({globals:r,globalTypes:e,...c})=>{this.facade.projectAnnotations.parameters=R(this.facade.projectAnnotations.parameters,c),r&&(this.facade.projectAnnotations.globals={...this.facade.projectAnnotations.globals,...r}),e&&(this.facade.projectAnnotations.globalTypes={...this.facade.projectAnnotations.globalTypes,...O(e)})};this.addStepRunner=r=>{this.facade.projectAnnotations.runStep=Q([this.facade.projectAnnotations.runStep,r].filter(Boolean))};this.addLoader=r=>{this.facade.projectAnnotations.loaders.push(r)};this.addArgs=r=>{this.facade.projectAnnotations.args={...this.facade.projectAnnotations.args,...r}};this.addArgTypes=r=>{this.facade.projectAnnotations.argTypes={...this.facade.projectAnnotations.argTypes,...O(r)}};this.addArgsEnhancer=r=>{this.facade.projectAnnotations.argsEnhancers.push(r)};this.addArgTypesEnhancer=r=>{this.facade.projectAnnotations.argTypesEnhancers.push(r)};this.storiesOf=(r,e)=>{if(!r&&typeof r!="string")throw new Error("Invalid or missing kind provided for stories, should be a string");if(e||j.warn(`Missing 'module' parameter for story with a kind of '${r}'. It will break your HMR`),e){let o=Object.getPrototypeOf(e);o.exports&&o.exports.default&&j.error(`Illegal mix of CSF default export and storiesOf calls in a single file: ${o.i}`)}let c=e&&e.id?`${e.id}`:(this.lastFileName++).toString(),p=c,g=1;for(;this.facade.csfExports[p]&&Object.keys(this.facade.csfExports[p]).length>0;)g+=1,p=`${c}-${g}`;e&&e.hot&&e.hot.accept&&(e.hot.accept(),e.hot.dispose(()=>{this.facade.clearFilenameExports(p),setTimeout(()=>{this.onImportFnChanged?.({importFn:this.importFn.bind(this)})},0)}));let m=!1,t={kind:r.toString(),add:()=>t,addDecorator:()=>t,addLoader:()=>t,addParameters:()=>t};Object.keys(this.addons).forEach(o=>{let i=this.addons[o];t[o]=(...n)=>(i.apply(t,n),t)});let s={id:K(r),title:r,decorators:[],loaders:[],parameters:{}};this.facade.csfExports[p]={default:s};let y=0;return t.add=(o,i,n={})=>{if(m=!0,typeof o!="string")throw new Error(`Invalid or missing storyName provided for a "${r}" story.`);if(!i||Array.isArray(i)||er.has(typeof i))throw new Error(`Cannot load story "${o}" in "${r}" due to invalid format. Storybook expected a function/object but received ${typeof i} instead.`);let{decorators:d,loaders:h,component:u,args:x,argTypes:A,...S}=n,k=n.__id||Y(r,o),I=this.facade.csfExports[p];return I[`story${y}`]={name:o,parameters:{fileName:p,__id:k,...S},decorators:d,loaders:h,args:x,argTypes:A,component:u,render:i},y+=1,this.facade.entries[k]={id:k,title:I.default.title,name:o,importPath:p,type:"story"},t},t.addDecorator=o=>{if(m)throw new Error(`You cannot add a decorator after the first story for a kind.
Read more here: https://github.com/storybookjs/storybook/blob/master/MIGRATION.md#can-no-longer-add-decoratorsparameters-after-stories`);return s.decorators.push(o),t},t.addLoader=o=>{if(m)throw new Error("You cannot add a loader after the first story for a kind.");return s.loaders.push(o),t},t.addParameters=({component:o,args:i,argTypes:n,...d})=>{if(m)throw new Error(`You cannot add parameters after the first story for a kind.
Read more here: https://github.com/storybookjs/storybook/blob/master/MIGRATION.md#can-no-longer-add-decoratorsparameters-after-stories`);return s.parameters=R(s.parameters,d),o&&(s.component=o),i&&(s.args={...s.args,...i}),n&&(s.argTypes={...s.argTypes,...n}),t},t};this.raw=()=>this.storyStore.raw();this.facade=new w,this.addons={},this.storyStore=r,f=this}importFn(r){return this.facade.importFn(r)}getStoryIndex(){if(!this.storyStore)throw new Error("Cannot get story index before setting storyStore");return this.facade.getStoryIndex(this.storyStore)}get _storyStore(){return this.storyStore}};import or from"global";import{parse as ar}from"qs";var{document:F}=or,sr=()=>F&&F.location&&F.location.search?ar(F.location.search,{ignoreQueryPrefix:!0}):{},Pr=a=>sr()[a];export*from"@storybook/store";export{b as ClientApi,q as addArgTypes,Z as addArgTypesEnhancer,J as addArgs,X as addArgsEnhancer,W as addDecorator,H as addLoader,B as addParameters,rr as addStepRunner,Pr as getQueryParam,sr as getQueryParams,tr as setGlobalRender};
